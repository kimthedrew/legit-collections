{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="mb-4">Complete Your Purchase</h2>
            
            {% if is_guest %}
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i> <strong>Guest Checkout</strong> - You're checking out as a guest. 
                <a href="{{ url_for('login') }}" class="alert-link">Login</a> or <a href="{{ url_for('register') }}" class="alert-link">Register</a> for faster checkout next time!
            </div>
            {% endif %}
            
            <!-- Single form wrapping all checkout fields -->
            <form method="POST" id="checkout-form">
                {% if form %}
                    {{ form.hidden_tag() }}
                {% elif guest_form %}
                    {{ guest_form.hidden_tag() }}
                {% endif %}

                <div class="row g-4">
                    <!-- Customer & Delivery Information (for guests) -->
                    {% if is_guest %}
                    <div class="col-12">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h4 class="card-title mb-3"><i class="bi bi-person-circle"></i> Customer Information</h4>
                                {% if guest_form %}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ guest_form.guest_name.label(class="form-label") }}
                                        {{ guest_form.guest_name(class="form-control", placeholder="Enter your full name") }}
                                        {% if guest_form.guest_name.errors %}
                                            <div class="text-danger small">{{ guest_form.guest_name.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ guest_form.guest_email.label(class="form-label") }}
                                        {{ guest_form.guest_email(class="form-control", placeholder="your.email@example.com") }}
                                        {% if guest_form.guest_email.errors %}
                                            <div class="text-danger small">{{ guest_form.guest_email.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ guest_form.guest_phone.label(class="form-label") }}
                                        {{ guest_form.guest_phone(class="form-control", placeholder="254712345678") }}
                                        <small class="text-muted">Format: 254XXXXXXXXX</small>
                                        {% if guest_form.guest_phone.errors %}
                                            <div class="text-danger small">{{ guest_form.guest_phone.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {{ guest_form.delivery_city.label(class="form-label") }}
                                        {{ guest_form.delivery_city(class="form-control", placeholder="Nairobi") }}
                                        {% if guest_form.delivery_city.errors %}
                                            <div class="text-danger small">{{ guest_form.delivery_city.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        {{ guest_form.delivery_address.label(class="form-label") }}
                                        {{ guest_form.delivery_address(class="form-control", rows="3", placeholder="Enter your complete delivery address") }}
                                        {% if guest_form.delivery_address.errors %}
                                            <div class="text-danger small">{{ guest_form.delivery_address.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        {{ guest_form.delivery_instructions.label(class="form-label") }}
                                        {{ guest_form.delivery_instructions(class="form-control", rows="2", placeholder="Optional: Any special delivery instructions") }}
                                        {% if guest_form.delivery_instructions.errors %}
                                            <div class="text-danger small">{{ guest_form.delivery_instructions.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Payment Section -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-3"><i class="bi bi-credit-card"></i> Payment Method</h4>
                                
                                <!-- Payment Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Choose Payment Method</label>
                                    
                                    <!-- M-Pesa STK Push (Direct) -->
                                    <div class="form-check mb-3 p-3 border rounded payment-option" data-method="mpesa_stk">
                                        <input class="form-check-input" type="radio" name="payment_method" id="mpesa_stk" value="mpesa_stk" checked>
                                        <label class="form-check-label w-100" for="mpesa_stk">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong><i class="bi bi-phone-fill text-success"></i> M-Pesa STK Push</strong>
                                                    <br>
                                                    <small class="text-muted">Instant payment popup on your phone</small>
                                                </div>
                                                <span class="badge bg-success">Recommended</span>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- Pesapal Option (Online Payment) -->
                                    <div class="form-check mb-3 p-3 border rounded payment-option" data-method="pesapal">
                                        <input class="form-check-input" type="radio" name="payment_method" id="pesapal" value="pesapal">
                                        <label class="form-check-label w-100" for="pesapal">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong><i class="bi bi-credit-card text-info"></i> Pesapal Gateway</strong>
                                                    <br>
                                                    <small class="text-muted">M-Pesa, Card, Bank Transfer</small>
                                                </div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <!-- Manual M-Pesa Option -->
                                    <div class="form-check p-3 border rounded payment-option" data-method="manual_mpesa">
                                        <input class="form-check-input" type="radio" name="payment_method" id="manual_mpesa" value="manual_mpesa">
                                        <label class="form-check-label w-100" for="manual_mpesa">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong><i class="bi bi-receipt text-primary"></i> Manual M-Pesa</strong>
                                                    <br>
                                                    <small class="text-muted">Pay via Till, enter code manually</small>
                                                </div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- M-Pesa STK Push Details (shown by default) -->
                                <div id="mpesaStkDetails" class="payment-details">
                                    <div class="alert alert-success">
                                        <i class="bi bi-phone-fill"></i>
                                        <strong>Instant M-Pesa Payment</strong>
                                        <ul class="mb-0 mt-2 small">
                                            <li>Enter your M-Pesa phone number</li>
                                            <li>You'll receive a payment prompt</li>
                                            <li>Enter your M-Pesa PIN</li>
                                            <li>Payment confirmed instantly!</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">M-Pesa Phone Number <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                            <input type="tel" name="mpesa_phone" class="form-control" 
                                                   placeholder="254712345678" 
                                                   pattern="254[0-9]{9}"
                                                   title="Format: 254XXXXXXXXX"
                                                   required>
                                        </div>
                                        <small class="text-muted">
                                            Format: 254XXXXXXXXX (e.g., 254712345678)
                                        </small>
                                    </div>
                                    
                                    <div class="alert alert-warning small">
                                        <i class="bi bi-info-circle"></i>
                                        Make sure your phone is on and you have your M-Pesa PIN ready. You have 60 seconds to complete the payment.
                                    </div>
                                </div>
                                
                                <!-- Pesapal Details (hidden by default) -->
                                <div id="pesapalDetails" class="payment-details" style="display:none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Quick & Secure Payment</strong>
                                        <ul class="mb-0 mt-2 small">
                                            <li>Click "Pay Now" to proceed</li>
                                            <li>Choose M-Pesa, Card, or Bank</li>
                                            <li>Complete payment securely</li>
                                            <li>Instant order confirmation</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Phone Number</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                            <input type="tel" name="phone_number" class="form-control" 
                                                   placeholder="254712345678" value="{{ current_user.email if current_user.is_authenticated else '' }}" required>
                                        </div>
                                        <small class="text-muted">For order updates</small>
                                    </div>
                                </div>
                                
                                <!-- Manual M-Pesa Details (hidden by default) -->
                                <div id="manualMpesaDetails" class="payment-details" style="display:none;">
                                    <div class="alert alert-warning">
                                        <strong>Payment Instructions:</strong>
                                        <ol class="mb-0 mt-2 small">
                                            <li>Go to M-PESA Menu</li>
                                            <li>Select "Lipa na M-PESA"</li>
                                            <li>Select "Buy Goods and Services"</li>
                                            <li>Enter Till Number: <strong>3598608</strong></li>
                                            <li>Enter Amount: <strong>Ksh{{ "%.2f"|format(total) }}</strong></li>
                                            <li>Enter your M-PESA PIN</li>
                                            <li>Copy the transaction code below</li>
                                        </ol>
                                    </div>
                                    
                                    {% if is_guest %}
                                    <div class="mb-3">
                                        <label class="form-label">Phone Number</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                            <input type="tel" name="phone_number" class="form-control" 
                                                   placeholder="254712345678" 
                                                   value="{% if guest_form %}{{ guest_form.guest_phone.data }}{% endif %}" 
                                                   required>
                                        </div>
                                        <small class="text-muted">For payment verification</small>
                                    </div>
                                    {% else %}
                                    <div class="mb-3">
                                        {{ form.phone_number.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                            {{ form.phone_number(class="form-control", placeholder="07XXXXXXXX") }}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <div class="mb-3">
                                        <label class="form-label">Payment Code <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-receipt"></i></span>
                                            {% if is_guest %}
                                                <input type="text" name="payment_code" class="form-control" 
                                                       placeholder="e.g. QA12BC3D4E" 
                                                       pattern="[A-Z0-9]{6,12}" 
                                                       required>
                                            {% else %}
                                                {{ form.payment_code(class="form-control", placeholder="e.g. QA12BC3D4E") }}
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">Enter M-PESA confirmation code</small>
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                        <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status"></span>
                                        <span id="btnText">
                                            <i class="bi bi-lock-fill"></i> Pay Now - Ksh{{ "%.2f"|format(total) }}
                                        </span>
                                    </button>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check"></i> Secure payment powered by Pesapal
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title mb-3"><i class="bi bi-bag-check"></i> Order Summary</h4>

                                <div class="list-group mb-3">
                                    {% for shoe in cart %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ shoe.name }}</h6>
                                                <small class="text-muted">Size: {{ shoe.size }}</small>
                                            </div>
                                            <span class="text-nowrap">Ksh{{ "%.2f"|format(shoe.price) }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span>Ksh{{ "%.2f"|format(total) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentOptions = document.querySelectorAll('input[name="payment_method"]');
    const mpesaStkDetails = document.getElementById('mpesaStkDetails');
    const pesapalDetails = document.getElementById('pesapalDetails');
    const manualMpesaDetails = document.getElementById('manualMpesaDetails');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const spinner = document.getElementById('spinner');
    
    // Payment method icons and labels
    const paymentConfig = {
        mpesa_stk: {
            text: '<i class="bi bi-phone-fill"></i> Pay with M-Pesa - Ksh{{ "%.2f"|format(total) }}',
            icon: 'bi-phone-fill'
        },
        pesapal: {
            text: '<i class="bi bi-lock-fill"></i> Pay Now - Ksh{{ "%.2f"|format(total) }}',
            icon: 'bi-lock-fill'
        },
        manual_mpesa: {
            text: '<i class="bi bi-receipt"></i> Confirm Payment - Ksh{{ "%.2f"|format(total) }}',
            icon: 'bi-receipt'
        }
    };
    
    // Utility: enable/disable and (un)require inputs inside a section
    function setSectionActive(sectionEl, isActive) {
        const inputs = sectionEl.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (isActive) {
                input.disabled = false;
                // Restore required only for fields explicitly marked via data-required
                if (input.dataset.required === 'true') {
                    input.required = true;
                }
            } else {
                // Remember if it was required, then disable and remove required so browser won't validate hidden fields
                if (input.required) {
                    input.dataset.required = 'true';
                }
                input.required = false;
                input.disabled = true;
            }
        });
    }

    // Initialize data-required flags for fields that are required by default
    (function initRequiredFlags() {
        document.querySelectorAll('#mpesaStkDetails [name="mpesa_phone"], #pesapalDetails [name="phone_number"], #manualMpesaDetails [name="phone_number"], #manualMpesaDetails [name="payment_code"]').forEach(input => {
            if (input.required) input.dataset.required = 'true';
        });
    })();

    // Handle payment method change
    paymentOptions.forEach(option => {
        option.addEventListener('change', function() {
            const method = this.value;
            
            // Hide all payment details
            mpesaStkDetails.style.display = 'none';
            pesapalDetails.style.display = 'none';
            manualMpesaDetails.style.display = 'none';
            // Disable all sections to avoid validating hidden inputs
            setSectionActive(mpesaStkDetails, false);
            setSectionActive(pesapalDetails, false);
            setSectionActive(manualMpesaDetails, false);
            
            // Remove 'active' class from all options
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('border-primary', 'bg-light');
            });
            
            // Show selected payment details
            if (method === 'mpesa_stk') {
                mpesaStkDetails.style.display = 'block';
                setSectionActive(mpesaStkDetails, true);
                btnText.innerHTML = paymentConfig.mpesa_stk.text;
            } else if (method === 'pesapal') {
                pesapalDetails.style.display = 'block';
                setSectionActive(pesapalDetails, true);
                btnText.innerHTML = paymentConfig.pesapal.text;
            } else if (method === 'manual_mpesa') {
                manualMpesaDetails.style.display = 'block';
                setSectionActive(manualMpesaDetails, true);
                btnText.innerHTML = paymentConfig.manual_mpesa.text;
            }
            
            // Highlight selected option
            this.closest('.payment-option').classList.add('border-primary', 'bg-light');
        });
    });
    
    // Highlight default selection and ensure only visible section is validated/enabled
    const defaultOption = document.querySelector('input[name="payment_method"]:checked');
    if (defaultOption) {
        defaultOption.closest('.payment-option').classList.add('border-primary', 'bg-light');
        // Start with mpesa_stk active by default
        setSectionActive(mpesaStkDetails, true);
        setSectionActive(pesapalDetails, false);
        setSectionActive(manualMpesaDetails, false);
    }
    
    // Form submission
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        const method = document.querySelector('input[name="payment_method"]:checked').value;
        
        spinner.classList.remove('d-none');
        submitBtn.disabled = true;
        
        if (method === 'mpesa_stk') {
            btnText.innerHTML = '<span class="ms-2">Sending payment request...</span>';
        } else {
            btnText.innerHTML = '<span class="ms-2">Processing...</span>';
        }
    });
});
</script>

<style>
.payment-option {
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-option:hover {
    background-color: #f8f9fa !important;
    border-color: #0d6efd !important;
}

.payment-option.border-primary {
    border-width: 2px !important;
}

.payment-details {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}