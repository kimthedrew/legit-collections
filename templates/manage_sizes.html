{% extends "base.html" %}

{% block title %}Manage Sizes - {{ shoe.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="bi bi-rulers"></i> Manage Sizes</h2>
                    <p class="text-muted mb-0">{{ shoe.name }}</p>
                </div>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Admin
                </a>
            </div>

            <!-- Product Preview -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <img src="{{ shoe.image_url }}" class="img-fluid rounded" alt="{{ shoe.name }}" style="max-height: 120px; object-fit: cover;">
                        </div>
                        <div class="col-md-9">
                            <h5 class="mb-1">{{ shoe.name }}</h5>
                            <p class="text-muted mb-1">{{ shoe.category }}</p>
                            <p class="text-success fw-bold mb-0">Ksh{{ "%.2f"|format(shoe.price) }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Size Selection Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-check2-square"></i> Select Available Sizes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        <i class="bi bi-info-circle"></i> Check the sizes that are currently in stock for this product.
                    </p>

                    <form method="POST" action="{{ url_for('update_shoe_sizes', shoe_id=shoe.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Predefined Sizes Grid -->
                        <div class="row g-3 mb-4">
                            {% set predefined_sizes = ['36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47'] %}
                            {% set existing_sizes = {} %}
                            {% for size in shoe.sizes %}
                                {% if existing_sizes.update({size.size: size.quantity > 0}) %}{% endif %}
                            {% endfor %}

                            {% for size_value in predefined_sizes %}
                            <div class="col-4 col-md-3 col-lg-2">
                                <div class="form-check size-checkbox">
                                    <input class="form-check-input" type="checkbox"
                                           name="sizes"
                                           value="{{ size_value }}"
                                           id="size{{ size_value }}"
                                           {% if existing_sizes.get(size_value, false) %}checked{% endif %}>
                                    <label class="form-check-label size-label" for="size{{ size_value }}">
                                        {{ size_value }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Quick Actions -->
                        <div class="d-flex gap-2 mb-4">
                            <button type="button" class="btn btn-outline-success btn-sm" id="selectAll">
                                <i class="bi bi-check-all"></i> Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAll">
                                <i class="bi bi-x-lg"></i> Deselect All
                            </button>
                        </div>

                        <hr>

                        <!-- Custom Size (Optional) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-plus-circle"></i> Add Custom Sizes (Optional)
                            </label>
                            <p class="text-muted small mb-2">
                                If you need sizes not listed above, enter them separated by commas (e.g., 35, 48, 10.5)
                            </p>
                            <input type="text" class="form-control" name="custom_sizes"
                                   placeholder="e.g., 35, 48, 10.5"
                                   pattern="^[\d.,\s]+$">
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin') }}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Save Sizes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Current Stock Summary -->
            {% if shoe.sizes %}
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-box-seam"></i> Current Stock Summary</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        {% for size in shoe.sizes|sort(attribute='size') %}
                            {% if size.quantity > 0 %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle"></i> Size {{ size.size }}
                            </span>
                            {% else %}
                            <span class="badge bg-secondary fs-6">
                                <i class="bi bi-x-circle"></i> Size {{ size.size }}
                            </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <p class="text-muted small mt-3 mb-0">
                        <i class="bi bi-info-circle"></i>
                        <strong>{{ shoe.sizes|selectattr('quantity', 'gt', 0)|list|length }}</strong> sizes in stock,
                        <strong>{{ shoe.sizes|selectattr('quantity', 'eq', 0)|list|length }}</strong> out of stock
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .size-checkbox {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px 10px;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .size-checkbox:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }

    .size-checkbox .form-check-input {
        display: none;
    }

    .size-checkbox .size-label {
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        display: block;
        margin: 0;
    }

    .size-checkbox .form-check-input:checked + .size-label {
        color: #198754;
    }

    .size-checkbox:has(.form-check-input:checked) {
        border-color: #198754;
        background-color: #d1e7dd;
    }

    .size-checkbox:has(.form-check-input:checked)::after {
        content: 'âœ“';
        position: absolute;
        top: 5px;
        right: 8px;
        color: #198754;
        font-weight: bold;
    }

    .size-checkbox {
        position: relative;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    const checkboxes = document.querySelectorAll('input[name="sizes"]');

    selectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = true);
    });

    deselectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
    });

    // Make the entire box clickable
    document.querySelectorAll('.size-checkbox').forEach(box => {
        box.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            }
        });
    });
});
</script>
{% endblock %}
